import{r as l,a as le,f as ne,e as oe,j as e,B as d,S as c,L as ce,s as x}from"./index-B1IGmRtD.js";import{u as de}from"./useQuery-BA7-oFOl.js";import{u as E,P as I,S as me}from"./useMutation-CViI-cFS.js";import{I as f}from"./input-DGhUk4PP.js";import{T as U}from"./textarea-CZqiqUI7.js";import{C as R,a as B,b as Q,c as $,d as K}from"./card-Cw1i-YhQ.js";import{P as he,E as O}from"./page-header-Bv2ymM8H.js";import{T as H,a as ue}from"./tag-BD69WoyC.js";import{c as xe}from"./markdown-utils-kUX-X2ax.js";import{b as ge,d as pe}from"./content-selects-Bl1-GPQZ.js";import{C as we}from"./calendar-BbdJ88Zm.js";import{C as fe}from"./clock-CDywXAON.js";import{E as be}from"./external-link-Cz28fLjv.js";const Y=()=>({title:"",slug:"",body:"",excerpt:"",tags:"",image_url:""}),Le=()=>{const[p,b]=l.useState(!1),[m,j]=l.useState(null),[a,n]=l.useState(Y),[W,G]=l.useState(!1),[v,N]=l.useState(!1),g=l.useRef(0),{toast:o}=le(),y=ne(),S=oe();l.useEffect(()=>{(async()=>{const{data:{user:s}}=await x.auth.getUser();s||(S("/admin/login"),o({title:"Unauthorized",description:"Please log in to access this page.",variant:"destructive"})),G(!0)})()},[S,o]);const{data:P,isLoading:T}=de({queryKey:["posts"],queryFn:async()=>{const{data:t,error:s}=await x.from("posts").select(pe).order("published_date",{ascending:!1});if(s)throw s;return t}}),i=l.useMemo(()=>P??[],[P]),k=i.length,M=l.useMemo(()=>{if(!i.length)return 0;const t=new Date;return i.filter(s=>{const r=new Date(s.created_at);return r.getMonth()===t.getMonth()&&r.getFullYear()===t.getFullYear()}).length},[i]),F=l.useMemo(()=>{if(!i.length)return 0;const t=i.reduce((s,r)=>s+(r.read_time||0),0);return Math.round(t/i.length)},[i]),L=l.useMemo(()=>i.length?new Set(i.flatMap(t=>t.tags||[])).size:0,[i]),J=l.useMemo(()=>[{label:"Total posts",value:k},{label:"This month",value:M},{label:"Unique tags",value:L},{label:"Avg read",value:`${F||0} min`}],[F,M,k,L]),V=T,C=E({mutationFn:async t=>{const{data:s,error:r}=await x.from("posts").insert([{...t,tags:t.tags?.length?t.tags:null}]).select().single();if(r)throw r;return s},onSuccess:()=>{y.invalidateQueries({queryKey:["posts"]}),w(),o({title:"Post added successfully!"})},onError:t=>{o({title:"Error adding post",description:t.message,variant:"destructive"})}}),_=E({mutationFn:async t=>{const{data:s,error:r}=await x.from("posts").update({title:t.title,slug:t.slug,body:t.body,excerpt:t.excerpt,tags:t.tags,published_date:t.published_date,read_time:t.read_time,image_url:t.image_url}).eq("id",t.id).select().single();if(r)throw r;return s},onSuccess:()=>{y.invalidateQueries({queryKey:["posts"]}),w(),o({title:"Post updated successfully!"})},onError:t=>{o({title:"Error updating post",description:t.message,variant:"destructive"})}}),q=C.isPending||_.isPending,D=q||v,X=E({mutationFn:async t=>{const{error:s}=await x.from("posts").delete().eq("id",t);if(s)throw s},onSuccess:()=>{y.invalidateQueries({queryKey:["posts"]}),o({title:"Post deleted successfully!"})},onError:t=>{o({title:"Error deleting post",description:t.message,variant:"destructive"})}}),Z=t=>t.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,""),A=()=>n(Y()),w=()=>{g.current+=1,b(!1),j(null),N(!1),A()},z=()=>{b(!0),j(null),A()},ee=()=>{p?w():z()},te=t=>{n({...a,title:t,slug:Z(t)})},se=async t=>{j(t),b(!0),N(!0);const s=g.current+=1;try{const{data:r,error:h}=await x.from("posts").select(ge).eq("id",t.id).maybeSingle();if(h)throw h;const u=r??t;if(s!==g.current)return;n({title:u.title,slug:u.slug,body:u.body||"",excerpt:u.excerpt||"",tags:u.tags?.join(", ")||"",image_url:u.image_url||""})}catch(r){if(console.warn("Failed to load full post content",r),s!==g.current)return;n({title:t.title,slug:t.slug,body:t.body||"",excerpt:t.excerpt||"",tags:t.tags?.join(", ")||"",image_url:t.image_url||""})}finally{s===g.current&&N(!1)}},ae=t=>{confirm("Are you sure you want to delete this post?")&&X.mutate(t)},re=t=>{if(t.preventDefault(),v){o({title:"Still loading",description:"Please wait for the full content to load before saving.",variant:"destructive"});return}if(!a.title.trim()||!a.slug.trim())return;const s=a.tags.split(",").map(h=>h.trim()).filter(h=>h.length>0),r={title:a.title,slug:a.slug,body:a.body||null,excerpt:a.excerpt||null,tags:s.length>0?s:null,published_date:m?.published_date||new Date().toISOString(),read_time:a.body?xe(a.body):0,image_url:a.image_url||null};m?_.mutate({...m,...r}):C.mutate(r)};if(!W)return e.jsx("div",{className:"min-h-screen bg-black text-white flex items-center justify-center",children:e.jsx("div",{className:"text-white/60 text-xl",children:"Checking authentication..."})});if(T)return e.jsx("div",{className:"min-h-screen bg-black text-white flex items-center justify-center",children:e.jsx("div",{className:"text-white/60",children:"Loading posts..."})});const ie=i.length>0;return e.jsx("div",{className:"min-h-screen bg-black text-white py-12",children:e.jsxs("div",{className:"container-site space-y-10 pb-24",children:[e.jsx(he,{eyebrow:"Admin",title:"Blog Posts",description:"Create, edit, and publish articles for imadlab.",breadcrumbs:[{label:"Admin",href:"/admin"},{label:"Posts",href:"/admin/posts"}],meta:J,actions:e.jsxs(d,{variant:p?"outline":"inverted",size:"lg",onClick:ee,disabled:q,children:[e.jsx(I,{className:"h-4 w-4 mr-2"}),p?"Cancel":"New Post"]})}),p&&e.jsxs(R,{className:"rounded-2xl border border-white/10 bg-white/[0.03] shadow-none",children:[e.jsxs(B,{children:[e.jsx(Q,{className:"text-white",children:m?"Edit Post":"Create New Post"}),e.jsx($,{className:"text-white/70",children:m?"Update your blog post details":"Add a new blog post to your collection"})]}),e.jsx(K,{children:e.jsxs("form",{onSubmit:re,className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-white/80",children:"Title"}),e.jsx(f,{placeholder:"Enter post title",value:a.title,onChange:t=>te(t.target.value),className:"bg-white/5 border-white/20 text-white placeholder:text-white/50",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-white/80",children:"Slug"}),e.jsx(f,{placeholder:"url-friendly-slug",value:a.slug,onChange:t=>n({...a,slug:t.target.value}),className:"bg-white/5 border-white/20 text-white placeholder:text-white/50",required:!0})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-white/80",children:"Excerpt"}),e.jsx(U,{placeholder:"Brief summary of your post",value:a.excerpt,onChange:t=>n({...a,excerpt:t.target.value}),className:"bg-white/5 border-white/20 text-white placeholder:text-white/50",rows:3})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-white/80",children:"Content"}),e.jsx(U,{placeholder:"Write your post content here...",value:a.body,onChange:t=>n({...a,body:t.target.value}),className:"bg-white/5 border-white/20 text-white placeholder:text-white/50",rows:12})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-white/80",children:"Featured Image URL"}),e.jsx(f,{placeholder:"https://example.com/image.jpg",value:a.image_url,onChange:t=>n({...a,image_url:t.target.value}),className:"bg-white/5 border-white/20 text-white placeholder:text-white/50"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-white/80",children:"Tags"}),e.jsx(f,{placeholder:"react, typescript, web development",value:a.tags,onChange:t=>n({...a,tags:t.target.value}),className:"bg-white/5 border-white/20 text-white placeholder:text-white/50"})]})]}),v&&e.jsx("div",{className:"rounded-md border border-white/10 bg-white/[0.02] px-3 py-2 text-xs text-white/60",children:"Loading full contentâ€¦"}),e.jsxs("div",{className:"flex flex-wrap gap-3",children:[e.jsx(d,{type:"submit",variant:"inverted",disabled:D,children:m?_.isPending?"Updating...":"Update Post":C.isPending?"Creating...":"Create Post"}),e.jsx(d,{type:"button",variant:"ghost",onClick:w,disabled:D,children:"Cancel"})]})]})})]}),e.jsxs(R,{className:"rounded-2xl border border-white/10 bg-white/[0.03] shadow-none",children:[e.jsxs(B,{children:[e.jsx(Q,{className:"text-white",children:"All Posts"}),e.jsx($,{className:"text-white/70",children:"Manage your blog posts"})]}),e.jsx(K,{children:V?e.jsx("div",{className:"space-y-4",children:Array.from({length:3}).map((t,s)=>e.jsxs("div",{className:"rounded-2xl border border-white/10 bg-white/[0.03] p-6",children:[e.jsx(c,{className:"h-6 w-2/3"}),e.jsxs("div",{className:"mt-3 flex flex-wrap gap-2",children:[e.jsx(c,{className:"h-6 w-24 rounded-full"}),e.jsx(c,{className:"h-6 w-20 rounded-full"}),e.jsx(c,{className:"h-6 w-16 rounded-full"})]}),e.jsx(c,{className:"mt-5 h-4 w-full"}),e.jsx(c,{className:"mt-2 h-4 w-3/5"}),e.jsxs("div",{className:"mt-6 flex flex-wrap gap-3",children:[e.jsx(c,{className:"h-9 w-24 rounded-lg"}),e.jsx(c,{className:"h-9 w-24 rounded-lg"}),e.jsx(c,{className:"h-9 w-24 rounded-lg"})]})]},s))}):ie?e.jsx("div",{className:"space-y-4",children:i.map(t=>e.jsx("div",{className:"rounded-2xl border border-white/10 bg-white/[0.02] p-5 transition hover:border-white/20",children:e.jsxs("div",{className:"flex flex-col gap-4 md:flex-row md:items-start md:justify-between",children:[e.jsxs("div",{className:"flex-1 space-y-3",children:[e.jsxs("div",{className:"flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between",children:[e.jsx("h3",{className:"text-lg font-semibold text-white",children:t.title}),t.tags&&t.tags.length>0&&e.jsxs("div",{className:"flex flex-wrap gap-2",children:[t.tags.slice(0,3).map((s,r)=>e.jsx(H,{size:"xs",variant:"outline",className:"text-white/80",children:s},`${t.id}-tag-${r}`)),t.tags.length>3&&e.jsxs(H,{size:"xs",variant:"subtle",className:"text-white/80",children:["+",t.tags.length-3]})]})]}),e.jsx("p",{className:"text-sm text-white/70 line-clamp-2",children:t.excerpt||"No excerpt available"}),e.jsxs("div",{className:"flex flex-wrap gap-4 text-xs text-white/60",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(we,{className:"h-3.5 w-3.5 text-white/50","aria-hidden":"true"}),new Date(t.published_date).toLocaleDateString()]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(fe,{className:"h-3.5 w-3.5 text-white/50","aria-hidden":"true"}),t.read_time||0," min read"]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(be,{className:"h-3.5 w-3.5 text-white/50","aria-hidden":"true"}),"/",t.slug]})]})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx(d,{asChild:!0,variant:"soft",size:"sm",children:e.jsxs(ce,{to:`/blogs/${t.slug}`,target:"_blank",rel:"noopener noreferrer",children:[e.jsx(O,{className:"mr-2 h-4 w-4"}),"Preview"]})}),e.jsxs(d,{variant:"soft",size:"sm",onClick:()=>se(t),children:[e.jsx(me,{className:"mr-2 h-4 w-4"}),"Edit"]}),e.jsxs(d,{variant:"destructive",size:"sm",onClick:()=>ae(t.id),children:[e.jsx(ue,{className:"mr-2 h-4 w-4"}),"Delete"]})]})]})},t.id))}):e.jsxs("div",{className:"py-12 text-center",children:[e.jsx(O,{className:"mx-auto mb-4 h-12 w-12 text-white/20","aria-hidden":"true"}),e.jsx("h3",{className:"text-lg font-semibold text-white",children:"No posts yet"}),e.jsx("p",{className:"mt-3 text-sm text-white/70",children:"Create your first blog post to get started."}),e.jsxs(d,{className:"mt-6",variant:"inverted",onClick:z,children:[e.jsx(I,{className:"mr-2 h-4 w-4"}),"Create First Post"]})]})})]})]})})};export{Le as default};
